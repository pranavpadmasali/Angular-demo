var WebcamComponent_1;
import { __decorate } from "tslib";
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { WebcamImage } from '../domain/webcam-image';
import { WebcamUtil } from '../util/webcam.util';
let WebcamComponent = WebcamComponent_1 = class WebcamComponent {
    constructor() {
        /** Defines the max width of the webcam area in px */
        this.width = 640;
        /** Defines the max height of the webcam area in px */
        this.height = 480;
        /** Defines base constraints to apply when requesting video track from UserMedia */
        this.videoOptions = WebcamComponent_1.DEFAULT_VIDEO_OPTIONS;
        /** Flag to enable/disable camera switch. If enabled, a switch icon will be displayed if multiple cameras were found */
        this.allowCameraSwitch = true;
        /** Flag to control whether an ImageData object is stored into the WebcamImage object. */
        this.captureImageData = false;
        /** The image type to use when capturing snapshots */
        this.imageType = WebcamComponent_1.DEFAULT_IMAGE_TYPE;
        /** The image quality to use when capturing snapshots (number between 0 and 1) */
        this.imageQuality = WebcamComponent_1.DEFAULT_IMAGE_QUALITY;
        /** EventEmitter which fires when an image has been captured */
        this.imageCapture = new EventEmitter();
        /** Emits a mediaError if webcam cannot be initialized (e.g. missing user permissions) */
        this.initError = new EventEmitter();
        /** Emits when the webcam video was clicked */
        this.imageClick = new EventEmitter();
        /** Emits the active deviceId after the active video device was switched */
        this.cameraSwitched = new EventEmitter();
        /** available video devices */
        this.availableVideoInputs = [];
        /** Indicates whether the video device is ready to be switched */
        this.videoInitialized = false;
        /** Index of active video in availableVideoInputs */
        this.activeVideoInputIndex = -1;
        /** MediaStream object in use for streaming UserMedia data */
        this.mediaStream = null;
        /** width and height of the active video stream */
        this.activeVideoSettings = null;
    }
    /**
     * If the given Observable emits, an image will be captured and emitted through 'imageCapture' EventEmitter
     */
    set trigger(trigger) {
        if (this.triggerSubscription) {
            this.triggerSubscription.unsubscribe();
        }
        // Subscribe to events from this Observable to take snapshots
        this.triggerSubscription = trigger.subscribe(() => {
            this.takeSnapshot();
        });
    }
    /**
     * If the given Observable emits, the active webcam will be switched to the one indicated by the emitted value.
     * @param switchCamera Indicates which webcam to switch to
     *   true: cycle forwards through available webcams
     *   false: cycle backwards through available webcams
     *   string: activate the webcam with the given id
     */
    set switchCamera(switchCamera) {
        if (this.switchCameraSubscription) {
            this.switchCameraSubscription.unsubscribe();
        }
        // Subscribe to events from this Observable to switch video device
        this.switchCameraSubscription = switchCamera.subscribe((value) => {
            if (typeof value === 'string') {
                // deviceId was specified
                this.switchToVideoInput(value);
            }
            else {
                // direction was specified
                this.rotateVideoInput(value !== false);
            }
        });
    }
    /**
     * Get MediaTrackConstraints to request streaming the given device
     * @param deviceId
     * @param baseMediaTrackConstraints base constraints to merge deviceId-constraint into
     * @returns
     */
    static getMediaConstraintsForDevice(deviceId, baseMediaTrackConstraints) {
        const result = baseMediaTrackConstraints ? baseMediaTrackConstraints : this.DEFAULT_VIDEO_OPTIONS;
        if (deviceId) {
            result.deviceId = { exact: deviceId };
        }
        return result;
    }
    /**
     * Tries to harvest the deviceId from the given mediaStreamTrack object.
     * Browsers populate this object differently; this method tries some different approaches
     * to read the id.
     * @param mediaStreamTrack
     * @returns deviceId if found in the mediaStreamTrack
     */
    static getDeviceIdFromMediaStreamTrack(mediaStreamTrack) {
        if (mediaStreamTrack.getSettings && mediaStreamTrack.getSettings() && mediaStreamTrack.getSettings().deviceId) {
            return mediaStreamTrack.getSettings().deviceId;
        }
        else if (mediaStreamTrack.getConstraints && mediaStreamTrack.getConstraints() && mediaStreamTrack.getConstraints().deviceId) {
            const deviceIdObj = mediaStreamTrack.getConstraints().deviceId;
            return WebcamComponent_1.getValueFromConstrainDOMString(deviceIdObj);
        }
    }
    /**
     * Tries to harvest the facingMode from the given mediaStreamTrack object.
     * Browsers populate this object differently; this method tries some different approaches
     * to read the value.
     * @param mediaStreamTrack
     * @returns facingMode if found in the mediaStreamTrack
     */
    static getFacingModeFromMediaStreamTrack(mediaStreamTrack) {
        if (mediaStreamTrack) {
            if (mediaStreamTrack.getSettings && mediaStreamTrack.getSettings() && mediaStreamTrack.getSettings().facingMode) {
                return mediaStreamTrack.getSettings().facingMode;
            }
            else if (mediaStreamTrack.getConstraints && mediaStreamTrack.getConstraints() && mediaStreamTrack.getConstraints().facingMode) {
                const facingModeConstraint = mediaStreamTrack.getConstraints().facingMode;
                return WebcamComponent_1.getValueFromConstrainDOMString(facingModeConstraint);
            }
        }
    }
    /**
     * Determines whether the given mediaStreamTrack claims itself as user facing
     * @param mediaStreamTrack
     */
    static isUserFacing(mediaStreamTrack) {
        const facingMode = WebcamComponent_1.getFacingModeFromMediaStreamTrack(mediaStreamTrack);
        return facingMode ? 'user' === facingMode.toLowerCase() : false;
    }
    /**
     * Extracts the value from the given ConstrainDOMString
     * @param constrainDOMString
     */
    static getValueFromConstrainDOMString(constrainDOMString) {
        if (constrainDOMString) {
            if (constrainDOMString instanceof String) {
                return String(constrainDOMString);
            }
            else if (Array.isArray(constrainDOMString) && Array(constrainDOMString).length > 0) {
                return String(constrainDOMString[0]);
            }
            else if (typeof constrainDOMString === 'object') {
                if (constrainDOMString['exact']) {
                    return String(constrainDOMString['exact']);
                }
                else if (constrainDOMString['ideal']) {
                    return String(constrainDOMString['ideal']);
                }
            }
        }
        return null;
    }
    ngAfterViewInit() {
        this.detectAvailableDevices()
            .then(() => {
            // start video
            this.switchToVideoInput(null);
        })
            .catch((err) => {
            this.initError.next({ message: err });
            // fallback: still try to load webcam, even if device enumeration failed
            this.switchToVideoInput(null);
        });
    }
    ngOnDestroy() {
        this.stopMediaTracks();
        this.unsubscribeFromSubscriptions();
    }
    /**
     * Takes a snapshot of the current webcam's view and emits the image as an event
     */
    takeSnapshot() {
        // set canvas size to actual video size
        const _video = this.nativeVideoElement;
        const dimensions = { width: this.width, height: this.height };
        if (_video.videoWidth) {
            dimensions.width = _video.videoWidth;
            dimensions.height = _video.videoHeight;
        }
        const _canvas = this.canvas.nativeElement;
        _canvas.width = dimensions.width;
        _canvas.height = dimensions.height;
        // paint snapshot image to canvas
        const context2d = _canvas.getContext('2d');
        context2d.drawImage(_video, 0, 0);
        // read canvas content as image
        const mimeType = this.imageType ? this.imageType : WebcamComponent_1.DEFAULT_IMAGE_TYPE;
        const quality = this.imageQuality ? this.imageQuality : WebcamComponent_1.DEFAULT_IMAGE_QUALITY;
        const dataUrl = _canvas.toDataURL(mimeType, quality);
        // get the ImageData object from the canvas' context.
        let imageData = null;
        if (this.captureImageData) {
            imageData = context2d.getImageData(0, 0, _canvas.width, _canvas.height);
        }
        this.imageCapture.next(new WebcamImage(dataUrl, mimeType, imageData));
    }
    /**
     * Switches to the next/previous video device
     * @param forward
     */
    rotateVideoInput(forward) {
        if (this.availableVideoInputs && this.availableVideoInputs.length > 1) {
            const increment = forward ? 1 : (this.availableVideoInputs.length - 1);
            const nextInputIndex = (this.activeVideoInputIndex + increment) % this.availableVideoInputs.length;
            this.switchToVideoInput(this.availableVideoInputs[nextInputIndex].deviceId);
        }
    }
    /**
     * Switches the camera-view to the specified video device
     */
    switchToVideoInput(deviceId) {
        this.videoInitialized = false;
        this.stopMediaTracks();
        this.initWebcam(deviceId, this.videoOptions);
    }
    /**
     * Event-handler for video resize event.
     * Triggers Angular change detection so that new video dimensions get applied
     */
    videoResize() {
        // here to trigger Angular change detection
    }
    get videoWidth() {
        const videoRatio = this.getVideoAspectRatio();
        return Math.min(this.width, this.height * videoRatio);
    }
    get videoHeight() {
        const videoRatio = this.getVideoAspectRatio();
        return Math.min(this.height, this.width / videoRatio);
    }
    get videoStyleClasses() {
        let classes = '';
        if (this.isMirrorImage()) {
            classes += 'mirrored ';
        }
        return classes.trim();
    }
    get nativeVideoElement() {
        return this.video.nativeElement;
    }
    /**
     * Returns the video aspect ratio of the active video stream
     */
    getVideoAspectRatio() {
        // calculate ratio from video element dimensions if present
        const videoElement = this.nativeVideoElement;
        if (videoElement.videoWidth && videoElement.videoWidth > 0 &&
            videoElement.videoHeight && videoElement.videoHeight > 0) {
            return videoElement.videoWidth / videoElement.videoHeight;
        }
        // nothing present - calculate ratio based on width/height params
        return this.width / this.height;
    }
    /**
     * Init webcam live view
     */
    initWebcam(deviceId, userVideoTrackConstraints) {
        const _video = this.nativeVideoElement;
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            // merge deviceId -> userVideoTrackConstraints
            const videoTrackConstraints = WebcamComponent_1.getMediaConstraintsForDevice(deviceId, userVideoTrackConstraints);
            navigator.mediaDevices.getUserMedia({ video: videoTrackConstraints })
                .then((stream) => {
                this.mediaStream = stream;
                _video.srcObject = stream;
                _video.play();
                this.activeVideoSettings = stream.getVideoTracks()[0].getSettings();
                const activeDeviceId = WebcamComponent_1.getDeviceIdFromMediaStreamTrack(stream.getVideoTracks()[0]);
                this.cameraSwitched.next(activeDeviceId);
                // Initial detect may run before user gave permissions, returning no deviceIds. This prevents later camera switches. (#47)
                // Run detect once again within getUserMedia callback, to make sure this time we have permissions and get deviceIds.
                this.detectAvailableDevices()
                    .then(() => {
                    this.activeVideoInputIndex = activeDeviceId ? this.availableVideoInputs
                        .findIndex((mediaDeviceInfo) => mediaDeviceInfo.deviceId === activeDeviceId) : -1;
                    this.videoInitialized = true;
                })
                    .catch(() => {
                    this.activeVideoInputIndex = -1;
                    this.videoInitialized = true;
                });
            })
                .catch((err) => {
                this.initError.next({ message: err.message, mediaStreamError: err });
            });
        }
        else {
            this.initError.next({ message: 'Cannot read UserMedia from MediaDevices.' });
        }
    }
    getActiveVideoTrack() {
        return this.mediaStream ? this.mediaStream.getVideoTracks()[0] : null;
    }
    isMirrorImage() {
        if (!this.getActiveVideoTrack()) {
            return false;
        }
        // check for explicit mirror override parameter
        {
            let mirror = 'auto';
            if (this.mirrorImage) {
                if (typeof this.mirrorImage === 'string') {
                    mirror = String(this.mirrorImage).toLowerCase();
                }
                else {
                    // WebcamMirrorProperties
                    if (this.mirrorImage.x) {
                        mirror = this.mirrorImage.x.toLowerCase();
                    }
                }
            }
            switch (mirror) {
                case 'always':
                    return true;
                case 'never':
                    return false;
            }
        }
        // default: enable mirroring if webcam is user facing
        return WebcamComponent_1.isUserFacing(this.getActiveVideoTrack());
    }
    /**
     * Stops all active media tracks.
     * This prevents the webcam from being indicated as active,
     * even if it is no longer used by this component.
     */
    stopMediaTracks() {
        if (this.mediaStream && this.mediaStream.getTracks) {
            // getTracks() returns all media tracks (video+audio)
            this.mediaStream.getTracks()
                .forEach((track) => track.stop());
        }
    }
    /**
     * Unsubscribe from all open subscriptions
     */
    unsubscribeFromSubscriptions() {
        if (this.triggerSubscription) {
            this.triggerSubscription.unsubscribe();
        }
        if (this.switchCameraSubscription) {
            this.switchCameraSubscription.unsubscribe();
        }
    }
    /**
     * Reads available input devices
     */
    detectAvailableDevices() {
        return new Promise((resolve, reject) => {
            WebcamUtil.getAvailableVideoInputs()
                .then((devices) => {
                this.availableVideoInputs = devices;
                resolve(devices);
            })
                .catch(err => {
                this.availableVideoInputs = [];
                reject(err);
            });
        });
    }
};
WebcamComponent.DEFAULT_VIDEO_OPTIONS = { facingMode: 'environment' };
WebcamComponent.DEFAULT_IMAGE_TYPE = 'image/jpeg';
WebcamComponent.DEFAULT_IMAGE_QUALITY = 0.92;
__decorate([
    Input()
], WebcamComponent.prototype, "width", void 0);
__decorate([
    Input()
], WebcamComponent.prototype, "height", void 0);
__decorate([
    Input()
], WebcamComponent.prototype, "videoOptions", void 0);
__decorate([
    Input()
], WebcamComponent.prototype, "allowCameraSwitch", void 0);
__decorate([
    Input()
], WebcamComponent.prototype, "mirrorImage", void 0);
__decorate([
    Input()
], WebcamComponent.prototype, "captureImageData", void 0);
__decorate([
    Input()
], WebcamComponent.prototype, "imageType", void 0);
__decorate([
    Input()
], WebcamComponent.prototype, "imageQuality", void 0);
__decorate([
    Output()
], WebcamComponent.prototype, "imageCapture", void 0);
__decorate([
    Output()
], WebcamComponent.prototype, "initError", void 0);
__decorate([
    Output()
], WebcamComponent.prototype, "imageClick", void 0);
__decorate([
    Output()
], WebcamComponent.prototype, "cameraSwitched", void 0);
__decorate([
    ViewChild('video', { static: true })
], WebcamComponent.prototype, "video", void 0);
__decorate([
    ViewChild('canvas', { static: true })
], WebcamComponent.prototype, "canvas", void 0);
__decorate([
    Input()
], WebcamComponent.prototype, "trigger", null);
__decorate([
    Input()
], WebcamComponent.prototype, "switchCamera", null);
WebcamComponent = WebcamComponent_1 = __decorate([
    Component({
        selector: 'webcam',
        template: "<div class=\"webcam-wrapper\" (click)=\"imageClick.next();\">\r\n  <video #video [width]=\"videoWidth\" [height]=\"videoHeight\" [class]=\"videoStyleClasses\" autoplay muted playsinline (resize)=\"videoResize()\"></video>\r\n  <div class=\"camera-switch\" *ngIf=\"allowCameraSwitch && availableVideoInputs.length > 1 && videoInitialized\" (click)=\"rotateVideoInput(true)\"></div>\r\n  <canvas #canvas [width]=\"width\" [height]=\"height\"></canvas>\r\n</div>\r\n",
        styles: [".webcam-wrapper{display:inline-block;position:relative;line-height:0}.webcam-wrapper video.mirrored{transform:scale(-1,1)}.webcam-wrapper canvas{display:none}.webcam-wrapper .camera-switch{background-color:rgba(0,0,0,.1);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAE9UlEQVR42u2aT2hdRRTGf+cRQqghSqihdBFDkRISK2KDfzDWxHaRQHEhaINKqa1gKQhd6EZLN+IidCH+Q0oWIkVRC21BQxXRitVaSbKoJSGtYGoK2tQ/tU1jY5v0c5F54Xl7b/KSO/PyEt+3e5f75p7zzZwzZ74zUEIJJfyfYaEGllQGVAGZlENdBy6Z2cSiYFTSKkkfS/pH/nBF0kFJdUW9AiRVASeAukD8DgNrzOySrwEzng18KaDzALXuG8W3AiStAvqBisBRNg40mtlPxbYCOgvgPO4bncWW+JpVeDQXRQhIygDfA00F5r0XuNfMrgclQFI98DDQCNQA5ZFXqoCWBVp8XwHRHeEqcN7loy/NbHBesyqpQ1KfFj/6nC+ZvFaApFrgPaCZpYVvgCfNbDiRAElNwGFg+RIt/X8H2s2s9wYCJDUAR4HqJX7++RN40MwGpgmQVAH0AQ2BPz4AHHPl8nBOAqtyFWQjsA6oL4Ada81sPDv7uwImod8kvSJp9RyS8O2SXnb/DYVd2Y9VSroQ4ANXJO2WVJmixqh0kzMWwL4LkiqRtDnA4D1zmfE8j9g9AezcnAHaPcfXdbfdnPZ2Yps6+DwAvO/Z1naTdApY7Xng48BDZnY1MpMVQBuw3iXc5Tnb0wBwBPjUzP6eoezuArZ6svM0geJLkvZEYnl3nkntoqROSbckSW2Suj3ZOIangc7GPJuUtNGdFIfmMeavktoSSKiW9LMPw30Q8JqkekmjCbOZRhuclLQjgYSNxUBAj6RyZ9ATgUJpUtJTCSR8vpAEXHAyWK5BXYFIGHOlepSAloUk4NEYgyoknQhEwhFJ0e8h6VSaQeerCb5uZgdi9utxYBNwOUD93hIVXswM4INCi6K9wAszFC2DwLOBDjHbYp59karIUnRdzYy/3ClqVklaUhfwTICj7K25OqA7a4wWagVsm4Me/xzwg2cCqqONFzO7DPxSCAJi436GUBgHHguQD2oTlJ55oSzP9ybccsttSJw1szdjFOSnI/8dTCGZHwcORp4Nx7y3B1iZ8/sm4MW8/Euxg5wIsS/HaAp3zeP4/G7obRDXI4jiTIA22H7Xdc7X+S3A5lC7QBQ357aq3VAjCeSkwUfAJrfvz+R8A9ADLAtZB+TinpjC5JMA+//jwPZZnF8G7J+L8z4IWB/zbG+gIujVWfLBW/NStVMmqaG4POJRsIjix7h8IGnLQuoBbQki5sVAJHyYm7YkNaRRtXwQ8G1cHpX0iKRrgUjYno17Sf0LrQhJUkdCeHWkVITGJI0k1QeS3ikGSUzOyJUJJNznYneuOCnpTldcxa2kP3xJYqOeSDjqZG8ShJLnE8TTuMS6Iyu1BW7djZqkfo9N0QOuYJmYQddfB7RG+gLTNzqAY9FrL+5/nwEbvDdJJe3zzOrhNP3AWRqmk55t3ZcBuj3b2gb0Sbrbo/NNzk7fFzu7s/E5EiC+rrmeQU0Kx2skvRFoOx2ZzlmSdgbsw49JetvtBpk8nM64d/cGbNtJ0s7cGyJlwHeEv+t3nqnLSgPAUOSGyG3AHUxdzqoJbEcvcL+ZTeTeEapzJKxgaeOcc/7Mf06D7kFrguS0VDAMtGadv+E47DT9tcChJej8ISfpD+abgTe45uOkFi8mnQ+JBVQ+d4VXuOptjavcyot8pq86mfwk8LWZnaOEEkoooYQSSojDv8AhQNeGfe0jAAAAAElFTkSuQmCC);background-repeat:no-repeat;border-radius:5px;position:absolute;right:13px;top:10px;height:48px;width:48px;background-size:80%;cursor:pointer;background-position:center;transition:background-color .2s}.webcam-wrapper .camera-switch:hover{background-color:rgba(0,0,0,.18)}"]
    })
], WebcamComponent);
export { WebcamComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViY2FtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC13ZWJjYW0vIiwic291cmNlcyI6WyJzcmMvYXBwL21vZHVsZXMvd2ViY2FtL3dlYmNhbS93ZWJjYW0uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFnQixTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBYSxNQUFNLEVBQUUsU0FBUyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBRTFHLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUVuRCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0scUJBQXFCLENBQUM7QUFRL0MsSUFBYSxlQUFlLHVCQUE1QixNQUFhLGVBQWU7SUFBNUI7UUFLRSxxREFBcUQ7UUFDckMsVUFBSyxHQUFXLEdBQUcsQ0FBQztRQUNwQyxzREFBc0Q7UUFDdEMsV0FBTSxHQUFXLEdBQUcsQ0FBQztRQUNyQyxtRkFBbUY7UUFDbkUsaUJBQVksR0FBMEIsaUJBQWUsQ0FBQyxxQkFBcUIsQ0FBQztRQUM1Rix1SEFBdUg7UUFDdkcsc0JBQWlCLEdBQVksSUFBSSxDQUFDO1FBR2xELHlGQUF5RjtRQUN6RSxxQkFBZ0IsR0FBWSxLQUFLLENBQUM7UUFDbEQscURBQXFEO1FBQ3JDLGNBQVMsR0FBVyxpQkFBZSxDQUFDLGtCQUFrQixDQUFDO1FBQ3ZFLGlGQUFpRjtRQUNqRSxpQkFBWSxHQUFXLGlCQUFlLENBQUMscUJBQXFCLENBQUM7UUFFN0UsK0RBQStEO1FBQzlDLGlCQUFZLEdBQThCLElBQUksWUFBWSxFQUFlLENBQUM7UUFDM0YseUZBQXlGO1FBQ3hFLGNBQVMsR0FBa0MsSUFBSSxZQUFZLEVBQW1CLENBQUM7UUFDaEcsOENBQThDO1FBQzdCLGVBQVUsR0FBdUIsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUMzRSwyRUFBMkU7UUFDMUQsbUJBQWMsR0FBeUIsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUVuRiw4QkFB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LEtBQUssRUFBRTswREFBMEM7QUFFekM7SUFBUixLQUFLLEVBQUU7b0RBQXFEO0FBRXBEO0lBQVIsS0FBSyxFQUFFO3lEQUEwQztBQUV6QztJQUFSLEtBQUssRUFBRTtrREFBK0Q7QUFFOUQ7SUFBUixLQUFLLEVBQUU7cURBQXFFO0FBR25FO0lBQVQsTUFBTSxFQUFFO3FEQUFrRjtBQUVqRjtJQUFULE1BQU0sRUFBRTtrREFBdUY7QUFFdEY7SUFBVCxNQUFNLEVBQUU7bURBQWtFO0FBRWpFO0lBQVQsTUFBTSxFQUFFO3VEQUEwRTtBQWlCN0M7SUFBckMsU0FBUyxDQUFDLE9BQU8sRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQzs4Q0FBb0I7QUFFbEI7SUFBdEMsU0FBUyxDQUFDLFFBQVEsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQzsrQ0FBcUI7QUFTM0Q7SUFEQyxLQUFLLEVBQUU7OENBVVA7QUFVRDtJQURDLEtBQUssRUFBRTttREFnQlA7QUEzRlUsZUFBZTtJQUwzQixTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsUUFBUTtRQUNsQiwyZEFBc0M7O0tBRXZDLENBQUM7R0FDVyxlQUFlLENBK1ozQjtTQS9aWSxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtBZnRlclZpZXdJbml0LCBDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uRGVzdHJveSwgT3V0cHV0LCBWaWV3Q2hpbGR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge1dlYmNhbUluaXRFcnJvcn0gZnJvbSAnLi4vZG9tYWluL3dlYmNhbS1pbml0LWVycm9yJztcclxuaW1wb3J0IHtXZWJjYW1JbWFnZX0gZnJvbSAnLi4vZG9tYWluL3dlYmNhbS1pbWFnZSc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9ufSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtXZWJjYW1VdGlsfSBmcm9tICcuLi91dGlsL3dlYmNhbS51dGlsJztcclxuaW1wb3J0IHtXZWJjYW1NaXJyb3JQcm9wZXJ0aWVzfSBmcm9tICcuLi9kb21haW4vd2ViY2FtLW1pcnJvci1wcm9wZXJ0aWVzJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnd2ViY2FtJyxcclxuICB0ZW1wbGF0ZVVybDogJy4vd2ViY2FtLmNvbXBvbmVudC5odG1sJyxcclxuICBzdHlsZVVybHM6IFsnLi93ZWJjYW0uY29tcG9uZW50LnNjc3MnXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgV2ViY2FtQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcclxuICBwcml2YXRlIHN0YXRpYyBERUZBVUxUX1ZJREVPX09QVElPTlM6IE1lZGlhVHJhY2tDb25zdHJhaW50cyA9IHtmYWNpbmdNb2RlOiAnZW52aXJvbm1lbnQnfTtcclxuICBwcml2YXRlIHN0YXRpYyBERUZBVUxUX0lNQUdFX1RZUEU6IHN0cmluZyA9ICdpbWFnZS9qcGVnJztcclxuICBwcml2YXRlIHN0YXRpYyBERUZBVUxUX0lNQUdFX1FVQUxJVFk6IG51bWJlciA9IDAuOTI7XHJcblxyXG4gIC8qKiBEZWZpbmVzIHRoZSBtYXggd2lkdGggb2YgdGhlIHdlYmNhbSBhcmVhIGluIHB4ICovXHJcbiAgQElucHV0KCkgcHVibGljIHdpZHRoOiBudW1iZXIgPSA2NDA7XHJcbiAgLyoqIERlZmluZXMgdGhlIG1heCBoZWlnaHQgb2YgdGhlIHdlYmNhbSBhcmVhIGluIHB4ICovXHJcbiAgQElucHV0KCkgcHVibGljIGhlaWdodDogbnVtYmVyID0gNDgwO1xyXG4gIC8qKiBEZWZpbmVzIGJhc2UgY29uc3RyYWludHMgdG8gYXBwbHkgd2hlbiByZXF1ZXN0aW5nIHZpZGVvIHRyYWNrIGZyb20gVXNlck1lZGlhICovXHJcbiAgQElucHV0KCkgcHVibGljIHZpZGVvT3B0aW9uczogTWVkaWFUcmFja0NvbnN0cmFpbnRzID0gV2ViY2FtQ29tcG9uZW50LkRFRkFVTFRfVklERU9fT1BUSU9OUztcclxuICAvKiogRmxhZyB0byBlbmFibGUvZGlzYWJsZSBjYW1lcmEgc3dpdGNoLiBJZiBlbmFibGVkLCBhIHN3aXRjaCBpY29uIHdpbGwgYmUgZGlzcGxheWVkIGlmIG11bHRpcGxlIGNhbWVyYXMgd2VyZSBmb3VuZCAqL1xyXG4gIEBJbnB1dCgpIHB1YmxpYyBhbGxvd0NhbWVyYVN3aXRjaDogYm9vbGVhbiA9IHRydWU7XHJcbiAgLyoqIFBhcmFtZXRlciB0byBjb250cm9sIGltYWdlIG1pcnJvcmluZyAoaS5lLiBmb3IgdXNlci1mYWNpbmcgY2FtZXJhKS4gW1wiYXV0b1wiLCBcImFsd2F5c1wiLCBcIm5ldmVyXCJdICovXHJcbiAgQElucHV0KCkgcHVibGljIG1pcnJvckltYWdlOiBzdHJpbmcgfCBXZWJjYW1NaXJyb3JQcm9wZXJ0aWVzO1xyXG4gIC8qKiBGbGFnIHRvIGNvbnRyb2wgd2hldGhlciBhbiBJbWFnZURhdGEgb2JqZWN0IGlzIHN0b3JlZCBpbnRvIHRoZSBXZWJjYW1JbWFnZSBvYmplY3QuICovXHJcbiAgQElucHV0KCkgcHVibGljIGNhcHR1cmVJbWFnZURhdGE6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAvKiogVGhlIGltYWdlIHR5cGUgdG8gdXNlIHdoZW4gY2FwdHVyaW5nIHNuYXBzaG90cyAqL1xyXG4gIEBJbnB1dCgpIHB1YmxpYyBpbWFnZVR5cGU6IHN0cmluZyA9IFdlYmNhbUNvbXBvbmVudC5ERUZBVUxUX0lNQUdFX1RZUEU7XHJcbiAgLyoqIFRoZSBpbWFnZSBxdWFsaXR5IHRvIHVzZSB3aGVuIGNhcHR1cmluZyBzbmFwc2hvdHMgKG51bWJlciBiZXR3ZWVuIDAgYW5kIDEpICovXHJcbiAgQElucHV0KCkgcHVibGljIGltYWdlUXVhbGl0eTogbnVtYmVyID0gV2ViY2FtQ29tcG9uZW50LkRFRkFVTFRfSU1BR0VfUVVBTElUWTtcclxuXHJcbiAgLyoqIEV2ZW50RW1pdHRlciB3aGljaCBmaXJlcyB3aGVuIGFuIGltYWdlIGhhcyBiZWVuIGNhcHR1cmVkICovXHJcbiAgQE91dHB1dCgpIHB1YmxpYyBpbWFnZUNhcHR1cmU6IEV2ZW50RW1pdHRlcjxXZWJjYW1JbWFnZT4gPSBuZXcgRXZlbnRFbWl0dGVyPFdlYmNhbUltYWdlPigpO1xyXG4gIC8qKiBFbWl0cyBhIG1lZGlhRXJyb3IgaWYgd2ViY2FtIGNhbm5vdCBiZSBpbml0aWFsaXplZCAoZS5nLiBtaXNzaW5nIHVzZXIgcGVybWlzc2lvbnMpICovXHJcbiAgQE91dHB1dCgpIHB1YmxpYyBpbml0RXJyb3I6IEV2ZW50RW1pdHRlcjxXZWJjYW1Jbml0RXJyb3I+ID0gbmV3IEV2ZW50RW1pdHRlcjxXZWJjYW1Jbml0RXJyb3I+KCk7XHJcbiAgLyoqIEVtaXRzIHdoZW4gdGhlIHdlYmNhbSB2aWRlbyB3YXMgY2xpY2tlZCAqL1xyXG4gIEBPdXRwdXQoKSBwdWJsaWMgaW1hZ2VDbGljazogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xyXG4gIC8qKiBFbWl0cyB0aGUgYWN0aXZlIGRldmljZUlkIGFmdGVyIHRoZSBhY3RpdmUgdmlkZW8gZGV2aWNlIHdhcyBzd2l0Y2hlZCAqL1xyXG4gIEBPdXRwdXQoKSBwdWJsaWMgY2FtZXJhU3dpdGNoZWQ6IEV2ZW50RW1pdHRlcjxzdHJpbmc+ID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XHJcblxyXG4gIC8qKiBhdmFpbGFibGUgdmlkZW8gZGV2aWNlcyAqL1xyXG4gIHB1YmxpYyBhdmFpbGFibGVWaWRlb0lucHV0czogTWVkaWFEZXZpY2VJbmZvW10gPSBbXTtcclxuXHJcbiAgLyoqIEluZGljYXRlcyB3aGV0aGVyIHRoZSB2aWRlbyBkZXZpY2UgaXMgcmVhZHkgdG8gYmUgc3dpdGNoZWQgKi9cclxuICBwdWJsaWMgdmlkZW9Jbml0aWFsaXplZDogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAvKiogSWYgdGhlIE9ic2VydmFibGUgcmVwcmVzZW50ZWQgYnkgdGhpcyBzdWJzY3JpcHRpb24gZW1pdHMsIGFuIGltYWdlIHdpbGwgYmUgY2FwdHVyZWQgYW5kIGVtaXR0ZWQgdGhyb3VnaFxyXG4gICAqIHRoZSAnaW1hZ2VDYXB0dXJlJyBFdmVudEVtaXR0ZXIgKi9cclxuICBwcml2YXRlIHRyaWdnZXJTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICAvKiogSW5kZXggb2YgYWN0aXZlIHZpZGVvIGluIGF2YWlsYWJsZVZpZGVvSW5wdXRzICovXHJcbiAgcHJpdmF0ZSBhY3RpdmVWaWRlb0lucHV0SW5kZXg6IG51bWJlciA9IC0xO1xyXG4gIC8qKiBTdWJzY3JpcHRpb24gdG8gc3dpdGNoQ2FtZXJhIGV2ZW50cyAqL1xyXG4gIHByaXZhdGUgc3dpdGNoQ2FtZXJhU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcbiAgLyoqIE1lZGlhU3RyZWFtIG9iamVjdCBpbiB1c2UgZm9yIHN0cmVhbWluZyBVc2VyTWVkaWEgZGF0YSAqL1xyXG4gIHByaXZhdGUgbWVkaWFTdHJlYW06IE1lZGlhU3RyZWFtID0gbnVsbDtcclxuICBAVmlld0NoaWxkKCd2aWRlbycsIHsgc3RhdGljOiB0cnVlIH0pIHByaXZhdGUgdmlkZW86IGFueTtcclxuICAvKiogQ2FudmFzIGZvciBWaWRlbyBTbmFwc2hvdHMgKi9cclxuICBAVmlld0NoaWxkKCdjYW52YXMnLCB7IHN0YXRpYzogdHJ1ZSB9KSBwcml2YXRlIGNhbnZhczogYW55O1xyXG5cclxuICAvKiogd2lkdGggYW5kIGhlaWdodCBvZiB0aGUgYWN0aXZlIHZpZGVvIHN0cmVhbSAqL1xyXG4gIHByaXZhdGUgYWN0aXZlVmlkZW9TZXR0aW5nczogTWVkaWFUcmFja1NldHRpbmdzID0gbnVsbDtcclxuXHJcbiAgLyoqXHJcbiAgICogSWYgdGhlIGdpdmVuIE9ic2VydmFibGUgZW1pdHMsIGFuIGltYWdlIHdpbGwgYmUgY2FwdHVyZWQgYW5kIGVtaXR0ZWQgdGhyb3VnaCAnaW1hZ2VDYXB0dXJlJyBFdmVudEVtaXR0ZXJcclxuICAgKi9cclxuICBASW5wdXQoKVxyXG4gIHB1YmxpYyBzZXQgdHJpZ2dlcih0cmlnZ2VyOiBPYnNlcnZhYmxlPHZvaWQ+KSB7XHJcbiAgICBpZiAodGhpcy50cmlnZ2VyU3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgIHRoaXMudHJpZ2dlclN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFN1YnNjcmliZSB0byBldmVudHMgZnJvbSB0aGlzIE9ic2VydmFibGUgdG8gdGFrZSBzbmFwc2hvdHNcclxuICAgIHRoaXMudHJpZ2dlclN1YnNjcmlwdGlvbiA9IHRyaWdnZXIuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgdGhpcy50YWtlU25hcHNob3QoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSWYgdGhlIGdpdmVuIE9ic2VydmFibGUgZW1pdHMsIHRoZSBhY3RpdmUgd2ViY2FtIHdpbGwgYmUgc3dpdGNoZWQgdG8gdGhlIG9uZSBpbmRpY2F0ZWQgYnkgdGhlIGVtaXR0ZWQgdmFsdWUuXHJcbiAgICogQHBhcmFtIHN3aXRjaENhbWVyYSBJbmRpY2F0ZXMgd2hpY2ggd2ViY2FtIHRvIHN3aXRjaCB0b1xyXG4gICAqICAgdHJ1ZTogY3ljbGUgZm9yd2FyZHMgdGhyb3VnaCBhdmFpbGFibGUgd2ViY2Ftc1xyXG4gICAqICAgZmFsc2U6IGN5Y2xlIGJhY2t3YXJkcyB0aHJvdWdoIGF2YWlsYWJsZSB3ZWJjYW1zXHJcbiAgICogICBzdHJpbmc6IGFjdGl2YXRlIHRoZSB3ZWJjYW0gd2l0aCB0aGUgZ2l2ZW4gaWRcclxuICAgKi9cclxuICBASW5wdXQoKVxyXG4gIHB1YmxpYyBzZXQgc3dpdGNoQ2FtZXJhKHN3aXRjaENhbWVyYTogT2JzZXJ2YWJsZTxib29sZWFuIHwgc3RyaW5nPikge1xyXG4gICAgaWYgKHRoaXMuc3dpdGNoQ2FtZXJhU3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgIHRoaXMuc3dpdGNoQ2FtZXJhU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gU3Vic2NyaWJlIHRvIGV2ZW50cyBmcm9tIHRoaXMgT2JzZXJ2YWJsZSB0byBzd2l0Y2ggdmlkZW8gZGV2aWNlXHJcbiAgICB0aGlzLnN3aXRjaENhbWVyYVN1YnNjcmlwdGlvbiA9IHN3aXRjaENhbWVyYS5zdWJzY3JpYmUoKHZhbHVlOiBib29sZWFuIHwgc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgLy8gZGV2aWNlSWQgd2FzIHNwZWNpZmllZFxyXG4gICAgICAgIHRoaXMuc3dpdGNoVG9WaWRlb0lucHV0KHZhbHVlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBkaXJlY3Rpb24gd2FzIHNwZWNpZmllZFxyXG4gICAgICAgIHRoaXMucm90YXRlVmlkZW9JbnB1dCh2YWx1ZSAhPT0gZmFsc2UpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldCBNZWRpYVRyYWNrQ29uc3RyYWludHMgdG8gcmVxdWVzdCBzdHJlYW1pbmcgdGhlIGdpdmVuIGRldmljZVxyXG4gICAqIEBwYXJhbSBkZXZpY2VJZFxyXG4gICAqIEBwYXJhbSBiYXNlTWVkaWFUcmFja0NvbnN0cmFpbnRzIGJhc2UgY29uc3RyYWludHMgdG8gbWVyZ2UgZGV2aWNlSWQtY29uc3RyYWludCBpbnRvXHJcbiAgICogQHJldHVybnNcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBnZXRNZWRpYUNvbnN0cmFpbnRzRm9yRGV2aWNlKGRldmljZUlkOiBzdHJpbmcsIGJhc2VNZWRpYVRyYWNrQ29uc3RyYWludHM6IE1lZGlhVHJhY2tDb25zdHJhaW50cyk6IE1lZGlhVHJhY2tDb25zdHJhaW50cyB7XHJcbiAgICBjb25zdCByZXN1bHQ6IE1lZGlhVHJhY2tDb25zdHJhaW50cyA9IGJhc2VNZWRpYVRyYWNrQ29uc3RyYWludHMgPyBiYXNlTWVkaWFUcmFja0NvbnN0cmFpbnRzIDogdGhpcy5ERUZBVUxUX1ZJREVPX09QVElPTlM7XHJcbiAgICBpZiAoZGV2aWNlSWQpIHtcclxuICAgICAgcmVzdWx0LmRldmljZUlkID0ge2V4YWN0OiBkZXZpY2VJZH07XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFRyaWVzIHRvIGhhcnZlc3QgdGhlIGRldmljZUlkIGZyb20gdGhlIGdpdmVuIG1lZGlhU3RyZWFtVHJhY2sgb2JqZWN0LlxyXG4gICAqIEJyb3dzZXJzIHBvcHVsYXRlIHRoaXMgb2JqZWN0IGRpZmZlcmVudGx5OyB0aGlzIG1ldGhvZCB0cmllcyBzb21lIGRpZmZlcmVudCBhcHByb2FjaGVzXHJcbiAgICogdG8gcmVhZCB0aGUgaWQuXHJcbiAgICogQHBhcmFtIG1lZGlhU3RyZWFtVHJhY2tcclxuICAgKiBAcmV0dXJucyBkZXZpY2VJZCBpZiBmb3VuZCBpbiB0aGUgbWVkaWFTdHJlYW1UcmFja1xyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGdldERldmljZUlkRnJvbU1lZGlhU3RyZWFtVHJhY2sobWVkaWFTdHJlYW1UcmFjazogTWVkaWFTdHJlYW1UcmFjayk6IHN0cmluZyB7XHJcbiAgICBpZiAobWVkaWFTdHJlYW1UcmFjay5nZXRTZXR0aW5ncyAmJiBtZWRpYVN0cmVhbVRyYWNrLmdldFNldHRpbmdzKCkgJiYgbWVkaWFTdHJlYW1UcmFjay5nZXRTZXR0aW5ncygpLmRldmljZUlkKSB7XHJcbiAgICAgIHJldHVybiBtZWRpYVN0cmVhbVRyYWNrLmdldFNldHRpbmdzKCkuZGV2aWNlSWQ7XHJcbiAgICB9IGVsc2UgaWYgKG1lZGlhU3RyZWFtVHJhY2suZ2V0Q29uc3RyYWludHMgJiYgbWVkaWFTdHJlYW1UcmFjay5nZXRDb25zdHJhaW50cygpICYmIG1lZGlhU3RyZWFtVHJhY2suZ2V0Q29uc3RyYWludHMoKS5kZXZpY2VJZCkge1xyXG4gICAgICBjb25zdCBkZXZpY2VJZE9iajogQ29uc3RyYWluRE9NU3RyaW5nID0gbWVkaWFTdHJlYW1UcmFjay5nZXRDb25zdHJhaW50cygpLmRldmljZUlkO1xyXG4gICAgICByZXR1cm4gV2ViY2FtQ29tcG9uZW50LmdldFZhbHVlRnJvbUNvbnN0cmFpbkRPTVN0cmluZyhkZXZpY2VJZE9iaik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBUcmllcyB0byBoYXJ2ZXN0IHRoZSBmYWNpbmdNb2RlIGZyb20gdGhlIGdpdmVuIG1lZGlhU3RyZWFtVHJhY2sgb2JqZWN0LlxyXG4gICAqIEJyb3dzZXJzIHBvcHVsYXRlIHRoaXMgb2JqZWN0IGRpZmZlcmVudGx5OyB0aGlzIG1ldGhvZCB0cmllcyBzb21lIGRpZmZlcmVudCBhcHByb2FjaGVzXHJcbiAgICogdG8gcmVhZCB0aGUgdmFsdWUuXHJcbiAgICogQHBhcmFtIG1lZGlhU3RyZWFtVHJhY2tcclxuICAgKiBAcmV0dXJucyBmYWNpbmdNb2RlIGlmIGZvdW5kIGluIHRoZSBtZWRpYVN0cmVhbVRyYWNrXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0RmFjaW5nTW9kZUZyb21NZWRpYVN0cmVhbVRyYWNrKG1lZGlhU3RyZWFtVHJhY2s6IE1lZGlhU3RyZWFtVHJhY2spOiBzdHJpbmcge1xyXG4gICAgaWYgKG1lZGlhU3RyZWFtVHJhY2spIHtcclxuICAgICAgaWYgKG1lZGlhU3RyZWFtVHJhY2suZ2V0U2V0dGluZ3MgJiYgbWVkaWFTdHJlYW1UcmFjay5nZXRTZXR0aW5ncygpICYmIG1lZGlhU3RyZWFtVHJhY2suZ2V0U2V0dGluZ3MoKS5mYWNpbmdNb2RlKSB7XHJcbiAgICAgICAgcmV0dXJuIG1lZGlhU3RyZWFtVHJhY2suZ2V0U2V0dGluZ3MoKS5mYWNpbmdNb2RlO1xyXG4gICAgICB9IGVsc2UgaWYgKG1lZGlhU3RyZWFtVHJhY2suZ2V0Q29uc3RyYWludHMgJiYgbWVkaWFTdHJlYW1UcmFjay5nZXRDb25zdHJhaW50cygpICYmIG1lZGlhU3RyZWFtVHJhY2suZ2V0Q29uc3RyYWludHMoKS5mYWNpbmdNb2RlKSB7XHJcbiAgICAgICAgY29uc3QgZmFjaW5nTW9kZUNvbnN0cmFpbnQ6IENvbnN0cmFpbkRPTVN0cmluZyA9IG1lZGlhU3RyZWFtVHJhY2suZ2V0Q29uc3RyYWludHMoKS5mYWNpbmdNb2RlO1xyXG4gICAgICAgIHJldHVybiBXZWJjYW1Db21wb25lbnQuZ2V0VmFsdWVGcm9tQ29uc3RyYWluRE9NU3RyaW5nKGZhY2luZ01vZGVDb25zdHJhaW50KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBnaXZlbiBtZWRpYVN0cmVhbVRyYWNrIGNsYWltcyBpdHNlbGYgYXMgdXNlciBmYWNpbmdcclxuICAgKiBAcGFyYW0gbWVkaWFTdHJlYW1UcmFja1xyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGlzVXNlckZhY2luZyhtZWRpYVN0cmVhbVRyYWNrOiBNZWRpYVN0cmVhbVRyYWNrKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBmYWNpbmdNb2RlOiBzdHJpbmcgPSBXZWJjYW1Db21wb25lbnQuZ2V0RmFjaW5nTW9kZUZyb21NZWRpYVN0cmVhbVRyYWNrKG1lZGlhU3RyZWFtVHJhY2spO1xyXG4gICAgcmV0dXJuIGZhY2luZ01vZGUgPyAndXNlcicgPT09IGZhY2luZ01vZGUudG9Mb3dlckNhc2UoKSA6IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRXh0cmFjdHMgdGhlIHZhbHVlIGZyb20gdGhlIGdpdmVuIENvbnN0cmFpbkRPTVN0cmluZ1xyXG4gICAqIEBwYXJhbSBjb25zdHJhaW5ET01TdHJpbmdcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBnZXRWYWx1ZUZyb21Db25zdHJhaW5ET01TdHJpbmcoY29uc3RyYWluRE9NU3RyaW5nOiBDb25zdHJhaW5ET01TdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgaWYgKGNvbnN0cmFpbkRPTVN0cmluZykge1xyXG4gICAgICBpZiAoY29uc3RyYWluRE9NU3RyaW5nIGluc3RhbmNlb2YgU3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIFN0cmluZyhjb25zdHJhaW5ET01TdHJpbmcpO1xyXG4gICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoY29uc3RyYWluRE9NU3RyaW5nKSAmJiBBcnJheShjb25zdHJhaW5ET01TdHJpbmcpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICByZXR1cm4gU3RyaW5nKGNvbnN0cmFpbkRPTVN0cmluZ1swXSk7XHJcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNvbnN0cmFpbkRPTVN0cmluZyA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICBpZiAoY29uc3RyYWluRE9NU3RyaW5nWydleGFjdCddKSB7XHJcbiAgICAgICAgICByZXR1cm4gU3RyaW5nKGNvbnN0cmFpbkRPTVN0cmluZ1snZXhhY3QnXSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjb25zdHJhaW5ET01TdHJpbmdbJ2lkZWFsJ10pIHtcclxuICAgICAgICAgIHJldHVybiBTdHJpbmcoY29uc3RyYWluRE9NU3RyaW5nWydpZGVhbCddKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmRldGVjdEF2YWlsYWJsZURldmljZXMoKVxyXG4gICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgLy8gc3RhcnQgdmlkZW9cclxuICAgICAgICB0aGlzLnN3aXRjaFRvVmlkZW9JbnB1dChudWxsKTtcclxuICAgICAgfSlcclxuICAgICAgLmNhdGNoKChlcnI6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIHRoaXMuaW5pdEVycm9yLm5leHQoPFdlYmNhbUluaXRFcnJvcj57bWVzc2FnZTogZXJyfSk7XHJcbiAgICAgICAgLy8gZmFsbGJhY2s6IHN0aWxsIHRyeSB0byBsb2FkIHdlYmNhbSwgZXZlbiBpZiBkZXZpY2UgZW51bWVyYXRpb24gZmFpbGVkXHJcbiAgICAgICAgdGhpcy5zd2l0Y2hUb1ZpZGVvSW5wdXQobnVsbCk7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy5zdG9wTWVkaWFUcmFja3MoKTtcclxuICAgIHRoaXMudW5zdWJzY3JpYmVGcm9tU3Vic2NyaXB0aW9ucygpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVGFrZXMgYSBzbmFwc2hvdCBvZiB0aGUgY3VycmVudCB3ZWJjYW0ncyB2aWV3IGFuZCBlbWl0cyB0aGUgaW1hZ2UgYXMgYW4gZXZlbnRcclxuICAgKi9cclxuICBwdWJsaWMgdGFrZVNuYXBzaG90KCk6IHZvaWQge1xyXG4gICAgLy8gc2V0IGNhbnZhcyBzaXplIHRvIGFjdHVhbCB2aWRlbyBzaXplXHJcbiAgICBjb25zdCBfdmlkZW8gPSB0aGlzLm5hdGl2ZVZpZGVvRWxlbWVudDtcclxuICAgIGNvbnN0IGRpbWVuc2lvbnMgPSB7d2lkdGg6IHRoaXMud2lkdGgsIGhlaWdodDogdGhpcy5oZWlnaHR9O1xyXG4gICAgaWYgKF92aWRlby52aWRlb1dpZHRoKSB7XHJcbiAgICAgIGRpbWVuc2lvbnMud2lkdGggPSBfdmlkZW8udmlkZW9XaWR0aDtcclxuICAgICAgZGltZW5zaW9ucy5oZWlnaHQgPSBfdmlkZW8udmlkZW9IZWlnaHQ7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgX2NhbnZhcyA9IHRoaXMuY2FudmFzLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICBfY2FudmFzLndpZHRoID0gZGltZW5zaW9ucy53aWR0aDtcclxuICAgIF9jYW52YXMuaGVpZ2h0ID0gZGltZW5zaW9ucy5oZWlnaHQ7XHJcblxyXG4gICAgLy8gcGFpbnQgc25hcHNob3QgaW1hZ2UgdG8gY2FudmFzXHJcbiAgICBjb25zdCBjb250ZXh0MmQgPSBfY2FudmFzLmdldENvbnRleHQoJzJkJyk7XHJcbiAgICBjb250ZXh0MmQuZHJhd0ltYWdlKF92aWRlbywgMCwgMCk7XHJcblxyXG4gICAgLy8gcmVhZCBjYW52YXMgY29udGVudCBhcyBpbWFnZVxyXG4gICAgY29uc3QgbWltZVR5cGU6IHN0cmluZyA9IHRoaXMuaW1hZ2VUeXBlID8gdGhpcy5pbWFnZVR5cGUgOiBXZWJjYW1Db21wb25lbnQuREVGQVVMVF9JTUFHRV9UWVBFO1xyXG4gICAgY29uc3QgcXVhbGl0eTogbnVtYmVyID0gdGhpcy5pbWFnZVF1YWxpdHkgPyB0aGlzLmltYWdlUXVhbGl0eSA6IFdlYmNhbUNvbXBvbmVudC5ERUZBVUxUX0lNQUdFX1FVQUxJVFk7XHJcbiAgICBjb25zdCBkYXRhVXJsOiBzdHJpbmcgPSBfY2FudmFzLnRvRGF0YVVSTChtaW1lVHlwZSwgcXVhbGl0eSk7XHJcblxyXG4gICAgLy8gZ2V0IHRoZSBJbWFnZURhdGEgb2JqZWN0IGZyb20gdGhlIGNhbnZhcycgY29udGV4dC5cclxuICAgIGxldCBpbWFnZURhdGE6IEltYWdlRGF0YSA9IG51bGw7XHJcblxyXG4gICAgaWYgKHRoaXMuY2FwdHVyZUltYWdlRGF0YSkge1xyXG4gICAgICBpbWFnZURhdGEgPSBjb250ZXh0MmQuZ2V0SW1hZ2VEYXRhKDAsIDAsIF9jYW52YXMud2lkdGgsIF9jYW52YXMuaGVpZ2h0KTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmltYWdlQ2FwdHVyZS5uZXh0KG5ldyBXZWJjYW1JbWFnZShkYXRhVXJsLCBtaW1lVHlwZSwgaW1hZ2VEYXRhKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTd2l0Y2hlcyB0byB0aGUgbmV4dC9wcmV2aW91cyB2aWRlbyBkZXZpY2VcclxuICAgKiBAcGFyYW0gZm9yd2FyZFxyXG4gICAqL1xyXG4gIHB1YmxpYyByb3RhdGVWaWRlb0lucHV0KGZvcndhcmQ6IGJvb2xlYW4pIHtcclxuICAgIGlmICh0aGlzLmF2YWlsYWJsZVZpZGVvSW5wdXRzICYmIHRoaXMuYXZhaWxhYmxlVmlkZW9JbnB1dHMubGVuZ3RoID4gMSkge1xyXG4gICAgICBjb25zdCBpbmNyZW1lbnQ6IG51bWJlciA9IGZvcndhcmQgPyAxIDogKHRoaXMuYXZhaWxhYmxlVmlkZW9JbnB1dHMubGVuZ3RoIC0gMSk7XHJcbiAgICAgIGNvbnN0IG5leHRJbnB1dEluZGV4ID0gKHRoaXMuYWN0aXZlVmlkZW9JbnB1dEluZGV4ICsgaW5jcmVtZW50KSAlIHRoaXMuYXZhaWxhYmxlVmlkZW9JbnB1dHMubGVuZ3RoO1xyXG4gICAgICB0aGlzLnN3aXRjaFRvVmlkZW9JbnB1dCh0aGlzLmF2YWlsYWJsZVZpZGVvSW5wdXRzW25leHRJbnB1dEluZGV4XS5kZXZpY2VJZCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTd2l0Y2hlcyB0aGUgY2FtZXJhLXZpZXcgdG8gdGhlIHNwZWNpZmllZCB2aWRlbyBkZXZpY2VcclxuICAgKi9cclxuICBwdWJsaWMgc3dpdGNoVG9WaWRlb0lucHV0KGRldmljZUlkOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMudmlkZW9Jbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gICAgdGhpcy5zdG9wTWVkaWFUcmFja3MoKTtcclxuICAgIHRoaXMuaW5pdFdlYmNhbShkZXZpY2VJZCwgdGhpcy52aWRlb09wdGlvbnMpO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIEV2ZW50LWhhbmRsZXIgZm9yIHZpZGVvIHJlc2l6ZSBldmVudC5cclxuICAgKiBUcmlnZ2VycyBBbmd1bGFyIGNoYW5nZSBkZXRlY3Rpb24gc28gdGhhdCBuZXcgdmlkZW8gZGltZW5zaW9ucyBnZXQgYXBwbGllZFxyXG4gICAqL1xyXG4gIHB1YmxpYyB2aWRlb1Jlc2l6ZSgpOiB2b2lkIHtcclxuICAgIC8vIGhlcmUgdG8gdHJpZ2dlciBBbmd1bGFyIGNoYW5nZSBkZXRlY3Rpb25cclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXQgdmlkZW9XaWR0aCgpIHtcclxuICAgIGNvbnN0IHZpZGVvUmF0aW8gPSB0aGlzLmdldFZpZGVvQXNwZWN0UmF0aW8oKTtcclxuICAgIHJldHVybiBNYXRoLm1pbih0aGlzLndpZHRoLCB0aGlzLmhlaWdodCAqIHZpZGVvUmF0aW8pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldCB2aWRlb0hlaWdodCgpIHtcclxuICAgIGNvbnN0IHZpZGVvUmF0aW8gPSB0aGlzLmdldFZpZGVvQXNwZWN0UmF0aW8oKTtcclxuICAgIHJldHVybiBNYXRoLm1pbih0aGlzLmhlaWdodCwgdGhpcy53aWR0aCAvIHZpZGVvUmF0aW8pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldCB2aWRlb1N0eWxlQ2xhc3NlcygpIHtcclxuICAgIGxldCBjbGFzc2VzOiBzdHJpbmcgPSAnJztcclxuXHJcbiAgICBpZiAodGhpcy5pc01pcnJvckltYWdlKCkpIHtcclxuICAgICAgY2xhc3NlcyArPSAnbWlycm9yZWQgJztcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gY2xhc3Nlcy50cmltKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IG5hdGl2ZVZpZGVvRWxlbWVudCgpIHtcclxuICAgIHJldHVybiB0aGlzLnZpZGVvLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSB2aWRlbyBhc3BlY3QgcmF0aW8gb2YgdGhlIGFjdGl2ZSB2aWRlbyBzdHJlYW1cclxuICAgKi9cclxuICBwcml2YXRlIGdldFZpZGVvQXNwZWN0UmF0aW8oKTogbnVtYmVyIHtcclxuICAgIC8vIGNhbGN1bGF0ZSByYXRpbyBmcm9tIHZpZGVvIGVsZW1lbnQgZGltZW5zaW9ucyBpZiBwcmVzZW50XHJcbiAgICBjb25zdCB2aWRlb0VsZW1lbnQgPSB0aGlzLm5hdGl2ZVZpZGVvRWxlbWVudDtcclxuICAgIGlmICh2aWRlb0VsZW1lbnQudmlkZW9XaWR0aCAmJiB2aWRlb0VsZW1lbnQudmlkZW9XaWR0aCA+IDAgJiZcclxuICAgICAgdmlkZW9FbGVtZW50LnZpZGVvSGVpZ2h0ICYmIHZpZGVvRWxlbWVudC52aWRlb0hlaWdodCA+IDApIHtcclxuXHJcbiAgICAgIHJldHVybiB2aWRlb0VsZW1lbnQudmlkZW9XaWR0aCAvIHZpZGVvRWxlbWVudC52aWRlb0hlaWdodDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBub3RoaW5nIHByZXNlbnQgLSBjYWxjdWxhdGUgcmF0aW8gYmFzZWQgb24gd2lkdGgvaGVpZ2h0IHBhcmFtc1xyXG4gICAgcmV0dXJuIHRoaXMud2lkdGggLyB0aGlzLmhlaWdodDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEluaXQgd2ViY2FtIGxpdmUgdmlld1xyXG4gICAqL1xyXG4gIHByaXZhdGUgaW5pdFdlYmNhbShkZXZpY2VJZDogc3RyaW5nLCB1c2VyVmlkZW9UcmFja0NvbnN0cmFpbnRzOiBNZWRpYVRyYWNrQ29uc3RyYWludHMpIHtcclxuICAgIGNvbnN0IF92aWRlbyA9IHRoaXMubmF0aXZlVmlkZW9FbGVtZW50O1xyXG4gICAgaWYgKG5hdmlnYXRvci5tZWRpYURldmljZXMgJiYgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEpIHtcclxuXHJcbiAgICAgIC8vIG1lcmdlIGRldmljZUlkIC0+IHVzZXJWaWRlb1RyYWNrQ29uc3RyYWludHNcclxuICAgICAgY29uc3QgdmlkZW9UcmFja0NvbnN0cmFpbnRzID0gV2ViY2FtQ29tcG9uZW50LmdldE1lZGlhQ29uc3RyYWludHNGb3JEZXZpY2UoZGV2aWNlSWQsIHVzZXJWaWRlb1RyYWNrQ29uc3RyYWludHMpO1xyXG5cclxuICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEoPE1lZGlhU3RyZWFtQ29uc3RyYWludHM+e3ZpZGVvOiB2aWRlb1RyYWNrQ29uc3RyYWludHN9KVxyXG4gICAgICAgIC50aGVuKChzdHJlYW06IE1lZGlhU3RyZWFtKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLm1lZGlhU3RyZWFtID0gc3RyZWFtO1xyXG4gICAgICAgICAgX3ZpZGVvLnNyY09iamVjdCA9IHN0cmVhbTtcclxuICAgICAgICAgIF92aWRlby5wbGF5KCk7XHJcblxyXG4gICAgICAgICAgdGhpcy5hY3RpdmVWaWRlb1NldHRpbmdzID0gc3RyZWFtLmdldFZpZGVvVHJhY2tzKClbMF0uZ2V0U2V0dGluZ3MoKTtcclxuICAgICAgICAgIGNvbnN0IGFjdGl2ZURldmljZUlkOiBzdHJpbmcgPSBXZWJjYW1Db21wb25lbnQuZ2V0RGV2aWNlSWRGcm9tTWVkaWFTdHJlYW1UcmFjayhzdHJlYW0uZ2V0VmlkZW9UcmFja3MoKVswXSk7XHJcblxyXG4gICAgICAgICAgdGhpcy5jYW1lcmFTd2l0Y2hlZC5uZXh0KGFjdGl2ZURldmljZUlkKTtcclxuXHJcbiAgICAgICAgICAvLyBJbml0aWFsIGRldGVjdCBtYXkgcnVuIGJlZm9yZSB1c2VyIGdhdmUgcGVybWlzc2lvbnMsIHJldHVybmluZyBubyBkZXZpY2VJZHMuIFRoaXMgcHJldmVudHMgbGF0ZXIgY2FtZXJhIHN3aXRjaGVzLiAoIzQ3KVxyXG4gICAgICAgICAgLy8gUnVuIGRldGVjdCBvbmNlIGFnYWluIHdpdGhpbiBnZXRVc2VyTWVkaWEgY2FsbGJhY2ssIHRvIG1ha2Ugc3VyZSB0aGlzIHRpbWUgd2UgaGF2ZSBwZXJtaXNzaW9ucyBhbmQgZ2V0IGRldmljZUlkcy5cclxuICAgICAgICAgIHRoaXMuZGV0ZWN0QXZhaWxhYmxlRGV2aWNlcygpXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVZpZGVvSW5wdXRJbmRleCA9IGFjdGl2ZURldmljZUlkID8gdGhpcy5hdmFpbGFibGVWaWRlb0lucHV0c1xyXG4gICAgICAgICAgICAgICAgLmZpbmRJbmRleCgobWVkaWFEZXZpY2VJbmZvOiBNZWRpYURldmljZUluZm8pID0+IG1lZGlhRGV2aWNlSW5mby5kZXZpY2VJZCA9PT0gYWN0aXZlRGV2aWNlSWQpIDogLTE7XHJcbiAgICAgICAgICAgICAgdGhpcy52aWRlb0luaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKCgpID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVZpZGVvSW5wdXRJbmRleCA9IC0xO1xyXG4gICAgICAgICAgICAgIHRoaXMudmlkZW9Jbml0aWFsaXplZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKChlcnI6IE1lZGlhU3RyZWFtRXJyb3IpID0+IHtcclxuICAgICAgICAgIHRoaXMuaW5pdEVycm9yLm5leHQoPFdlYmNhbUluaXRFcnJvcj57bWVzc2FnZTogZXJyLm1lc3NhZ2UsIG1lZGlhU3RyZWFtRXJyb3I6IGVycn0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5pbml0RXJyb3IubmV4dCg8V2ViY2FtSW5pdEVycm9yPnttZXNzYWdlOiAnQ2Fubm90IHJlYWQgVXNlck1lZGlhIGZyb20gTWVkaWFEZXZpY2VzLid9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0QWN0aXZlVmlkZW9UcmFjaygpOiBNZWRpYVN0cmVhbVRyYWNrIHtcclxuICAgIHJldHVybiB0aGlzLm1lZGlhU3RyZWFtID8gdGhpcy5tZWRpYVN0cmVhbS5nZXRWaWRlb1RyYWNrcygpWzBdIDogbnVsbDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNNaXJyb3JJbWFnZSgpOiBib29sZWFuIHtcclxuICAgIGlmICghdGhpcy5nZXRBY3RpdmVWaWRlb1RyYWNrKCkpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGNoZWNrIGZvciBleHBsaWNpdCBtaXJyb3Igb3ZlcnJpZGUgcGFyYW1ldGVyXHJcbiAgICB7XHJcbiAgICAgIGxldCBtaXJyb3I6IHN0cmluZyA9ICdhdXRvJztcclxuICAgICAgaWYgKHRoaXMubWlycm9ySW1hZ2UpIHtcclxuICAgICAgICBpZiAodHlwZW9mIHRoaXMubWlycm9ySW1hZ2UgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICBtaXJyb3IgPSBTdHJpbmcodGhpcy5taXJyb3JJbWFnZSkudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8gV2ViY2FtTWlycm9yUHJvcGVydGllc1xyXG4gICAgICAgICAgaWYgKHRoaXMubWlycm9ySW1hZ2UueCkge1xyXG4gICAgICAgICAgICBtaXJyb3IgPSB0aGlzLm1pcnJvckltYWdlLngudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHN3aXRjaCAobWlycm9yKSB7XHJcbiAgICAgICAgY2FzZSAnYWx3YXlzJzpcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIGNhc2UgJ25ldmVyJzpcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGRlZmF1bHQ6IGVuYWJsZSBtaXJyb3JpbmcgaWYgd2ViY2FtIGlzIHVzZXIgZmFjaW5nXHJcbiAgICByZXR1cm4gV2ViY2FtQ29tcG9uZW50LmlzVXNlckZhY2luZyh0aGlzLmdldEFjdGl2ZVZpZGVvVHJhY2soKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdG9wcyBhbGwgYWN0aXZlIG1lZGlhIHRyYWNrcy5cclxuICAgKiBUaGlzIHByZXZlbnRzIHRoZSB3ZWJjYW0gZnJvbSBiZWluZyBpbmRpY2F0ZWQgYXMgYWN0aXZlLFxyXG4gICAqIGV2ZW4gaWYgaXQgaXMgbm8gbG9uZ2VyIHVzZWQgYnkgdGhpcyBjb21wb25lbnQuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdG9wTWVkaWFUcmFja3MoKSB7XHJcbiAgICBpZiAodGhpcy5tZWRpYVN0cmVhbSAmJiB0aGlzLm1lZGlhU3RyZWFtLmdldFRyYWNrcykge1xyXG4gICAgICAvLyBnZXRUcmFja3MoKSByZXR1cm5zIGFsbCBtZWRpYSB0cmFja3MgKHZpZGVvK2F1ZGlvKVxyXG4gICAgICB0aGlzLm1lZGlhU3RyZWFtLmdldFRyYWNrcygpXHJcbiAgICAgICAgLmZvckVhY2goKHRyYWNrOiBNZWRpYVN0cmVhbVRyYWNrKSA9PiB0cmFjay5zdG9wKCkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVW5zdWJzY3JpYmUgZnJvbSBhbGwgb3BlbiBzdWJzY3JpcHRpb25zXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1bnN1YnNjcmliZUZyb21TdWJzY3JpcHRpb25zKCkge1xyXG4gICAgaWYgKHRoaXMudHJpZ2dlclN1YnNjcmlwdGlvbikge1xyXG4gICAgICB0aGlzLnRyaWdnZXJTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLnN3aXRjaENhbWVyYVN1YnNjcmlwdGlvbikge1xyXG4gICAgICB0aGlzLnN3aXRjaENhbWVyYVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVhZHMgYXZhaWxhYmxlIGlucHV0IGRldmljZXNcclxuICAgKi9cclxuICBwcml2YXRlIGRldGVjdEF2YWlsYWJsZURldmljZXMoKTogUHJvbWlzZTxNZWRpYURldmljZUluZm9bXT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgV2ViY2FtVXRpbC5nZXRBdmFpbGFibGVWaWRlb0lucHV0cygpXHJcbiAgICAgICAgLnRoZW4oKGRldmljZXM6IE1lZGlhRGV2aWNlSW5mb1tdKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmF2YWlsYWJsZVZpZGVvSW5wdXRzID0gZGV2aWNlcztcclxuICAgICAgICAgIHJlc29sdmUoZGV2aWNlcyk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgIHRoaXMuYXZhaWxhYmxlVmlkZW9JbnB1dHMgPSBbXTtcclxuICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxufVxyXG4iXX0=